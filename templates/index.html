{% extends "base.html" %}
{% load static %}
{% block extra_head %}
 <style>

      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }

      .link:hover {
        stroke-opacity: .5;
      }

</style>

{% endblock %}

{% block content %}
<div class="container">
  <div class="row">

    <main class="col-sm-12 ml-sm-auto col-md-12 pt-3" role="main">
      <section id="main" class="row text-center placeholders">
		  <div class="col-sm-4">
		    <div class="card">
		      <div class="card-body">
		        <h4 class="card-title">{{ parties|length }} <small>Part{{ parties|pluralize:"y,ies" }}</small></h4>
		        <p><a href="/pivot/">> Pivot</a></p>
		      	<div id="partyChart"></div>
		      </div>
		    </div>
		  </div>
		  <div class="col-sm-4">
		    <div class="card">
		      <div class="card-body">
		        <h4 class="card-title">{{ securities|length }} <small>Securit{{ securities|pluralize:"y,ies" }}</small></h4>
		      </div>
		    </div>
		  </div>
		  <div class="col-sm-4">
		    <div class="card">
		      <div class="card-body">
		        <h4 class="card-title">{{ holdings|length }} <small>Holding{{ holdings|pluralize }}</small></h4>
		      </div>
		    </div>
		  </div>
		  <div id="graph" class="col-sm-12"></div>
      </section>
	  {% if parties %}
      <section id="parties">
      <div class="row">
        <h2>Parties</h2>
      </div>
    	 <div class="table-responsive">
		  <table class="table">
		    <tr>
			    <th>Name</th>
			    <th>Lei</th>
			    <th>Holder role</th>
			    <th>Sector/Industry</th>
			    <th>Country</th>
			  </tr>
			  {% for party in parties %}
			  <tr>
			    <td>{{ party.name }}</td>
			    <td>{{ party.lei }}</td>
			    <td>{% if party.holder_role %}{{ party.holder_role }}{% else %}Unknown{% endif %}</td>
			    <td>{% if party.sector_industry %}{{ party.sector_industry }}{% else %}Unknown{% endif %}</td>
			    <td>{{ party.country }}</td>
			  </tr>
			  {% endfor %}
		  </table>
		</div>
      </section>
	  {% endif %}
	  {% if securities %}
      <section id="securities">
        <div class="row">
        	<h2>Securities</h2>
      	</div>
    	 <div class="table-responsive">
		  <table class="table">
		    <tr>
			    <th>ISIN</th>
			    <th>Issuer</th>
			    <th></th>
			  </tr>
			  {% for security in securities %}
			  <tr>
			    <td>{{ security.isin }}</td>
			    <td>{% if security.issuer %}{{ security.issuer }}{% else %}Unknown{% endif %}</td>
			    <td><a href="/custodian/{{ security.pk }}/" class="btn btn-outline-primary btn-sm"  role="button">Custodian report</a>
			    <a href="/issuer/{{ security.pk }}/" class="btn btn-outline-success btn-sm"  role="button">Issuer report</a></td>
			  </tr>
			  {% endfor %}
		  </table>
		</div>
      </section>
	  {% endif %}
	  {% if holdings %}
      <section id="holdings">
        <div class="row">
        <h2>Holdings</h2>
      </div>
    	 <div class="table-responsive">
		  <table class="table">
		    <tr>
			    <th>Link</th>
			    <th>Security</th>
			    <th>Amount</th>
			    <th>Currency</th>
			  </tr>
			  {% for holding in holdings %}
			  <tr>
			    <td>{% if holding.relation_type == "200" or holding.relation_type == '800' %}{{ holding.party_to }} - {{ holding.party_from }}
			    	{% else %}{{ holding.party_from }} - {{ holding.party_to }}{% endif %}</td>
			    <td>{{ holding.security.isin }}</td>
			    <td>{{ holding.amount }}</td>
			    <td>{{ holding.currency }}</td>
			  </tr>
			  {% endfor %}
		  </table>
		</div>
      </section>
	  {% endif %}
    </main>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
var units = "Widgets";

var margin = {top: 10, right: 10, bottom: 10, left: 10},
    width = 1110 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20(),
    sankeycolor = d3.scale.category20();


////////////////////
// Directed graph //
////////////////////
var force = d3.layout.force()
    .charge(-120)
    .linkDistance(100)
    .size([width, height]);


var graphsvg = d3.select("#graph").append("svg")
    .attr("width", width)
    .attr("height", height);


d3.json("/get/holding/graph/", function(error, graph) {
  if (error) throw error;

  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();



  var link = graphsvg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", 2);
      //.style("stroke-width", function(d) { return Math.sqrt(d.value); });

  // add the link titles
  link.append("title")
        .text(function(d) {
        return d.source.name + " â†’ " + 
                d.target.name + "\n" + format(d.amount); });

  var node = graphsvg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("circle")
      .attr("class", "node")
      .attr("r", 10)
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);


  node.append("title")
      .text(function(d) { return d.name; });

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });

 verticalLegend = d3.svg.legend()
   .labelFormat("none").cellPadding(5)
   .orientation("vertical")
   .units("Role")
   .cellWidth(25)
   .cellHeight(18)
   .inputScale(color)
   .cellStepping(10);

  graphsvg.append("g")
    .attr("transform", "translate(50,140)")
    .attr("class", "legend")
    .call(verticalLegend);
});

function mouseover() {
  d3.select(this).select("circle").transition()
  .duration(350)
  .attr("r", 20);
}

function mouseout() {
  d3.select(this).select("circle").transition()
  .duration(350)
  .attr("r" , 15);
}
</script>
{% endblock %}